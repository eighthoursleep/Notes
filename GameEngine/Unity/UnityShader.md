# Unity Shader

## 渲染流水线的3个概念
1. 应用阶段：输出渲染图元
2. 几何阶段：输出屏幕空间的顶点信息
3. 光栅化阶段

### 应用阶段
此阶段由应用主导，由CPU负责实现，开发者具有这一阶段的绝对控制权。

应用阶段的3个主要任务：
1. 准备好场景数据，如摄像机位置、视锥体、场景中包含的模型、光源等。
2. 为提高渲染性能，做一个粗颗粒剔除（culling），把不可见的物体剔除，不需要将这些物体交给几何阶段处理。
3. 设置好每个模型的渲染状态，包括但不限于材质、纹理、shader等。输出渲染图元（rendering primitives），及输出点、线、三角面等。

### 几何阶段

这个阶段处理所有和我们要绘制的几何相关事情。如：绘制的什么图元，怎么绘制，在哪绘制。

这个阶段通常在GPU上进行。

几何阶段负责和每个渲染图元打交道，逐点逐多边形操作。

几何阶段的重要任务是把顶点坐标变换到屏幕空间中。

这一阶段输出屏幕空间的二维顶点坐标、每个顶点对应的深度值、着色等相关信息。

### 光栅化阶段

这一阶段产生屏幕上的像素，渲染出最终图像。

这一阶段也再GPU上进行。

光栅化的任务主要是决定每个渲染图元中的哪些像素应该被绘制在屏幕上。它需要对上一阶段得到的逐顶点数据（如纹理坐标、顶点颜色等）进行插值，然后再逐像素处理。

## CPU和GPU之间的通信

渲染流水线的起点是CPU，即应用阶段。应用阶段大致分为以下3个阶段：
1. 把数据加载到显存中。
2. 设置渲染状态。
3. 调用Drawcall。

### 把数据加载到显存

所有的渲染所需数据都是从硬盘加载到RAM中，然后网格和纹理等数据又被加载到显存中。因为显卡对显存的访问速度更快，大多数显卡对RAM没有直接访问的权力。

当把数据加载到显存中后，RAM中的数据就可以移除了。但对于一些数据，CPU仍需要访问它们，这部分数据不需要移除。

### 设置渲染状态

渲染状态定义了场景中的网格是怎样被渲染的。例如，使用哪个顶点着色器/片元着色器、光源属性、材质等。

如果没有更改渲染状态，所有的网格都将使用同一种渲染状态。

### 调用Drawcall

Drawcall是一个命令，由CPU发起，GPU接收。这个命令仅仅指向一个需要被渲染的图元列表，不会再包含任何材质信息。

当给定一个drawcall时，GPU根据渲染状态（材质、纹理着色器等）和所有输入的顶点数据来进行计算，最终输出成屏幕上显示的像素。这个过程就是gpu流水线。

## GPU流水线

GPU渲染的过程就是GPU流水线

对于几何阶段和光栅化阶段，开发者没有绝对控制权，实现载体时GPU。

GPU通过实现流水线，加快渲染速度。

虽然无法控制这两个阶段的实现细节，但GPU向开发者开放了很多控制权。

顶点数据是由应用阶段加载到显存中，再由drawcall指定的。这些数据最后被传递给顶点着色器进入几何阶段。

### 几何阶段

【顶点着色器】是完全可编程的，它通常用于实现顶点的空间变换、顶点着色等功能。顶点着色器处理完后将结果传给曲面细分着色器。

【曲面细分着色器】（Tessellation Shader）是一个可选的着色器，它用于细分图元。处理结果传入几何着色器。

【几何着色器】同样是一个可选的着色器，可以被用于执行逐图元的着色操作，或者被用于产生更多的图元。处理完后进入裁剪阶段。

【裁剪】的目的是将不在摄像机视野内的顶点裁剪掉，剔除除某些三角图元的片元。这个阶段是可配置的。

例如，我们可以使用自定义的裁剪平面来配置裁剪区域，也可以通过指令控制裁剪三角图元的正面还是背面。

【屏幕映射】（Screen Mapping）是几何阶段的最后一个流水线阶段。这个阶段不可配置和编程，负责把每个图元的坐标转换到屏幕坐标系中。

### 光栅化阶段

【三角形设置】（Triangle Setup）是固定函数（Fixed-Function）的阶段

【三角形遍历】（Triangle Traversal）也是固定函数阶段

【片元着色器】完全可编程，用于实现逐片元的着色操作。

【逐片元操作】不可编程，可配置。负责很多重要操作，例如修改颜色、深度缓冲、混合等。

### 顶点着色器

流水线的第1阶段，输入来自CPU。

顶点着色器的处理单位是顶点。

输入进来的每个顶点都会调用一次顶点着色器。

顶点着色器本身不可以创建或销毁任何顶点，无法得到顶点之间的关系。例如无法得知两个顶点是否属于同一个三角网络。

因为这样的相互独立性，GPU优化处理每一个顶点。

这一阶段的处理速度很快。

#### 主要工作

1. 坐标变换
2. 逐顶点光照

坐标变换：顶点着色器可以在这一步中改变顶点的位置。

坐标变换在顶点动画中非常有用。例如改变顶点位置来模拟水面、布料等。

不论怎么改变顶点位置，一个最基本的顶点着色器必须完成的工作是，把顶点坐标从模型空间转换到齐次裁剪空间。