# 图形渲染管线

[TOC]

渲染管线的主要作用就是在给定虚拟相机、三维物体、光源、照明模式，以及纹理等诸多条件下，生成或者说绘制一张二维图像。

图像中的物体的形状、位置由物体的几何结构、环境特点、相机摆放决定。

物体的表面显示受材质属性、光源、贴图、着色器公式影响。

## 渲染管线的体系结构

### 管线的概念

现实世界中管线的表现方式例如：输油管道、工厂装配线、滑雪缆车等

一条管线包括多个阶段，无论其中个别管线速度有多快，管线的整体快慢程度由管线中最慢的那个阶段决定。

### 渲染管线的4个主要阶段

最基本的渲染管线有以下4个主要阶段：
1. 应用程序
2. 几何处理
3. 光栅化
4. 像素处理

每个阶段自身也可能是一条管线，即可以包含几个子阶段。

图像更新速度，或者说渲染速度一般由帧率（fps）描述，即每秒绘制的图像数量。

应用阶段由应用程序驱动，因此可以通过软件实现。例如这个阶段可以包括碰撞检测、加速算法、动画以及力反馈等。这一阶段一般在CPU上进行

几何处理阶段处理的是变换、投影、光照等几。这一阶段计算出要绘制的内容、如何绘制、在哪个位置绘制。这一阶段在GPU上进行。

光珊阶段利用前面阶段产生的数据进行图像绘制。将每三个顶点组成一个三角形，找到所有的三角形内的在像素，将这些像素传递到下一阶段。这一阶段在GPU上进行。

像素处理阶段决定每一个像素应该是什么颜色，测试深度来决定这个像素是否可见。像素处理阶段还进行逐像素操作，例如混合新颜色与旧颜色。这一阶段在GPU上进行。

## 应用程序阶段

开发者在这一阶段有完全的控制权。因为这一阶段在CPU上进行。
我们可以在这个阶段决定实现方式，或修改实现方式来提高性能。
例如在应用阶段通过某个算法或者属性设置减少要渲染的三角形数量来达到目的。

在应用程序阶段的末端，将需要绘制的几何体输入到管线的下一阶段。
这些几何体都绘制图元（点、线、三角形等）。

由于应用程序阶段基于软件实现，因此不能像几何和光栅阶段那样可以继续分成若干个子阶段。
但是为了提高性能，该阶段可以在几个并行处理器中同时执行。
在CPU设计上称为超标量体系结构，因为它可以在同一阶段同一时间做不同的几件事。

在应用程序阶段，通常实现的方法有碰撞检测。当检测到两个物体之间存在碰撞关系时，就会产生一个信号并送回给碰撞物体，如同力反馈器那样。
此外应用程序阶段也是检查其他输入信号源的地方，如键盘、鼠标、VR头盔等，根据具体输入采取相应不同的操作。
在这个阶段实现的其他过程还包括纹理动画、变换仿真、几何变形，以及一些在其他阶段执行的计算。例如层次视锥裁剪、加速算法等。

这一阶段有一部分可以在GPU上进行，通过一种分离的模式，即计算着色器。

这种模式视GPU为高度并行运作的处理器

## 几何阶段

几何阶段在GPU上进行，主要负责大部分逐三角形和逐顶点操作，可以将这个阶段再进一步划分：
顶点着色 => 投影 => 裁剪 => 屏幕映射

### 顶点着色

顶点着色阶段有2个主要任务：
1. 计算顶点位置
2. 程序员期望的顶点输出数据，例如一条法线和贴图坐标。

传统上，一个物体的大量阴影是这么计算出来的：
对每一个节点的位置和法线施加光照，并存储产生的颜色到顶点上。这些颜色值通过插值遍布三角形。

因此，可编程节点处理单元被称为节点着色器。

伴随现代GPU的面世，以及每个像素都会进行一些着色操作或者全部的着色操作，这个顶点着色阶段更加普遍，可能会根据程序员的意图而不进行着色解方程。

节点着色器现在是一种更普遍用于设置有关节点的数据的处理单元。

